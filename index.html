<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body {
        width: 100wh;
        height: 90vh;
        color: #fff;
        background: linear-gradient(-45deg, #EE7752, #E73C7E, #23A6D5, #23D5AB);
        background-size: 400% 400%;
        -webkit-animation: Gradient 15s ease infinite;
        -moz-animation: Gradient 15s ease infinite;
        animation: Gradient 15s ease infinite;
      }

      @-webkit-keyframes Gradient {
        0% {
          background-position: 0% 50%
        }
        50% {
          background-position: 100% 50%
        }
        100% {
          background-position: 0% 50%
        }
      }

      @-moz-keyframes Gradient {
        0% {
          background-position: 0% 50%
        }
        50% {
          background-position: 100% 50%
        }
        100% {
          background-position: 0% 50%
        }
      }

      @keyframes Gradient {
        0% {
          background-position: 0% 50%
        }
        50% {
          background-position: 100% 50%
        }
        100% {
          background-position: 0% 50%
        }
      }

      h1 {
        color : white ;
        font-family: sans-serif ;
        font-size : 50px ;
        font-weight: 800 ;          
      }

      p {
        color : white ;
        font-family: sans-serif ;        
        font-size : 20px ;  
        font-weight: 500 ;
      }

      .btn {
        border-radius: 15px ; 
        border: 2px solid black ; 
        background-color: white ; 
        color: black ; 
        padding: 14px 28px ; 
        font-size: 16px ; 
        cursor: pointer ; 
      }

      .view {
        border-color: #4CAF50 ; 
        color: green ; 
      }

      .view:hover {
        background-color: #4CAF50 ; 
        color: white ; 
      }

      .write {
        border-color:red ;
        color: darkred ;  
      }

      .write:hover {
        background-color: red ; 
        color: white ; 
      }

      .center {
        display: block ; 
        margin-left: auto ; 
        margin-right: auto ; 
        width: 20% ; 
      }

      .container {
        position: relative ;
        text-align: center ; 
        color: white ; 
      }

      .horseName {
        position: absolute ;
        top: 58% ; 
        left: 50% ; 
        transform: translate(-50%, -50%) ;
        font-family: sans-serif ; 
        font-size: 30px ; 
      }

      .horseID {
        position: absolute ;
        top: 0.5% ; 
        left: 44% ; 
        font-family: sans-serif ; 
        font-size: 19px ; 
      }

      .horseStrength {
        position: absolute ;
        top: 66.8% ; 
        left: 47% ; 
        font-family: sans-serif ; 
        font-size: 15px ; 
      }

      .horseStamina {
        position: absolute ;
        top: 75% ; 
        left: 47% ; 
        font-family: sans-serif ; 
        font-size: 15px ; 
      }

      .horseSpeed {
        position: absolute ;
        top: 83% ; 
        left: 46% ; 
        font-family: sans-serif ; 
        font-size: 15px ; 
      }

      .horseCooldown {
        position: absolute ;
        top: 91.8% ; 
        left: 47.6% ; 
        font-family: sans-serif ; 
        font-size: 14px ; 
        display: inline-block;
      }

    </style>  
    <meta charset="UTF-8">
    <title>Lupe Chummies</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="web3.min.js"></script>
    <script language="javascript" type="text/javascript" src="mainABI.js"></script>
    <script language="javascript" type="text/javascript" src="bettingABI.js"></script>
    <script language="javascript" type="text/javascript" src="paymentABI.js"></script>
  </head>
  <body onload="init()">
      
      <center><h1>Welcome to the Lupecoin dApp! (UNDER CONSTRUCTION) </h1></center>

      <div class="container">
        <img src = "horse1EDIT2.png" id = "horsePicture" class = "center">
        <div class = "horseName" id = "horseName"> - </div>
        <div class = "horseID" id = "horseID"> - </div>
        <div class = "horseStrength" id = "horseStrength"> - </div>
        <div class = "horseStamina" id = "horseStamina"> - </div>
        <div class = "horseSpeed" id = "horseSpeed"> - </div>
        <div class = "horseCooldown" id = "horseCooldown"> - </div>
      </div>

      <button class = "btn view" onclick="getHorse(0)">Get Genesis Horse Strength</button>
      <button class = "btn view" onclick="getHorse(1)">Get Genesis Horse Speed</button>
      <button class = "btn view" onclick="getHorse(2)">Get Genesis Horse Stamina</button>

      <button class = "btn view" onclick="getHorse(3)">Get Genesis Horse Ready Time</button>

      <button class = "btn view" onclick="getLUPXBalance()">Get LUPX Balance</button>

      <button class = "btn write" onclick="upgradeStrength()">Upgrade Horse Strength</button>
      <button class = "btn write" onclick="upgradeSpeed()">Upgrade Horse Speed</button>
      <button class = "btn write" onclick="upgradeStamina()">Upgrade Horse Stamina</button>

      <button class = "btn view" onclick="getHorseAmount()">Get Horse Amount</button>
      <button class = "btn write" onclick="buyNewHorse()">Buy New Horse</button>

      <select onchange="horseSelected()" id = "horseSelection">
        <option value="0">Horse ID: 0</option>
        <option value="1">Horse ID: 1</option>
        <option value="2">Horse ID: 2</option>
        <option value="3">Horse ID: 3</option>
      </select>

    <script>  
        //web3 provider definition
        const web3 = new Web3(window.web3.currentProvider) ;

        //addresses
        const maindApp = "0xd99903bd5946b0400959906fada0f1d96c3be757" ; 
        const bettingdApp = "0x9dbc7f725f674313b74bc19851c98d4d358804db" ;  
        const paymentdApp = "0xfb2f36ceb41f429a42d4d957518789dda5874041" ; 

        //contract instances
        var maindAppContract = new web3.eth.Contract(mainABI, maindApp) ; 
        var bettingContract = new web3.eth.Contract(bettingABI, bettingdApp) ; 
        var paymentContract = new web3.eth.Contract(paymentABI, paymentdApp) ;  

        //constants
        const net = "3" ;

        function init() {
          checkMetaMask() ; 
          updateLayout(document.getElementById("horseSelection").value) ;
          loadHorsePicture() ; 
        }

        function horseSelected() {
          selected = document.getElementById("horseSelection").value; 
          
          updateLayout(selected) ; 
        }

        function callGetTotalsupply() {
          return maindAppContract.methods.totalSupply().call()
        }

        function callGetOwner(N) {
          return maindAppContract.methods.ownerOfHorse(N).call() ; 
        }

        function inviteNotification() {
          var result ;
          if (confirm("Someone invited you for a race!")) {
            result = true ; 
          } else { result = false ; }
          return result ; 
        }

        function updateLayout(ID) {
          var ts = Math.round((new Date()).getTime() / 1000);
          callGetHorse(ID).then(function(value) {
            $("#horseName").html(value.name) ;
            $("#horseStrength").html(value.strength) ;
            $("#horseStamina").html(value.stamina) ;
            $("#horseSpeed").html(value.speed) ; 
            $("#horseID").html(0) ;           //!UPDATE ID DATA!

            if (value.readyTime - ts >= 0) {  //READY TIME CALCULATION
              $("#horseCooldown").html(value.readyTime - ts) ;
            } else {$("#horseCooldown").html("Ready!") ;}
          }) ;  
        }

        function loadHorsePicture() {
          callGetHorse(0).then(function(value) {
            if (value.tier == 1) {
              document.getElementById("horsePicture").src = "horse1EDIT2.png" ;  
            }

            if (value.tier == 2) {
              document.getElementById("horsePicture").src = "horse2.png" ; 
            }

            if (value.tier == 3) {
              document.getElementById("horsePicture").src = "horse3.png" ;
            }

            if (value.tier == 4) {
              document.getElementById("horsePicture").src = "horse4.png" ;
            }
          }) ; 
        }

        function checkMetaMask() {
          web3.eth.getAccounts().then(function(value) {
          
          if (value.length >= 1) {
           // alert("You are currently using this address: " + value[0]) ; 
            unlocked = true ; 
            } 
          else {alert("Make sure you have unlocked MetaMask.") ; return false ;}  

          if (web3.currentProvider.networkVersion == net) {
             network = true ; 
          }
          else {alert("Make sure you're connected to the Ropsten testnet!") ; return false ;}
          }) ; 
        }

        web3.eth.getAccounts().then(function(value) {account = value[0]}) ;

        function callGetHorse(number) {
          return maindAppContract.methods.horses(number).call() ; 
        }

        function getHorse(property) {
          if (property == 0) {      //STRENGTH
            callGetHorse(0).then(function(value) {
            alert(value.strength) ; }) ; 
          }
          
          if (property == 1) {      //SPEED
            callGetHorse(0).then(function(value) {
            alert(value.speed) ; }) ; 
          }

          if (property == 2) {      //STAMINA
            callGetHorse(0).then(function(value) {
            alert(value.stamina) ; }) ; 
          }   

          if (property == 3) {      //READY TIME
            callGetHorse(0).then(function(value) {
              alert(value.readyTime) ; }) ;
          } 
        }

        function upgradeSpeed() {
          maindAppContract.methods.upgradeSpeed(0).send({from: account}) ; 
        }

        function upgradeStamina() {
          maindAppContract.methods.upgradeStamina(0).send({from: account}) ; 
        }

        function upgradeStrength() {
          maindAppContract.methods.upgradeStrength(0).send({from: account}) ;
    //      maindAppContract.methods.upgradeStrength(0).estimateGas({from : account}).then(function(gasAmount){ 
    //        gas = gasAmount ; })     
        }

        function callLUPXBalance() {
          return paymentContract.methods.balanceOf(web3.currentProvider.selectedAddress).call()
        }

        function getLUPXBalance() {
          callLUPXBalance().then(function(value) {
            alert("LUPX owned: " + value/10**18) ; 
            return value ; 
          }) ; 
        }

        function callBalanceOf() {
          return maindAppContract.methods.balanceOf(web3.currentProvider.selectedAddress).call() ; 
        }

        function getHorseAmount() {
          callBalanceOf().then(function(value) {
            alert("Owned horse amount: " + value) ;
            return value ;  
          }) ;
        }

        function buyNewHorse() {
          maindAppContract.methods.buyNewHorse("TestHorse").send({from: account}) ; 
        }
        
        //====================[EVENTS]====================
        maindAppContract.events.newHorse({}, (error, result) => {
          if (!error) {
            console.log(result, result.returnValues.horseId, result.returnValues.name) ; 
          } else {console.log(error) ; }
        }) ; 

        maindAppContract.events.invite({}, (error, result) => {
          if (!error) {
            inviteNotification() ;  
          } else {console.log(error) ; }
        }) ; 

    </script>
  </body>
</html>
